
name: Build SpeedFlix APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3-pip \
          openjdk-11-jdk \
          zlib1g-dev \
          ccache \
          libncurses5 \
          libncursesw5 \
          unzip \
          zip \
          libssl-dev \
          libffi-dev \
          autoconf \
          libtool \
          pkg-config \
          wget \
          curl
    
    - name: Install Python Dependencies
      run: |
        python3 -m pip install --upgrade pip wheel setuptools virtualenv
        python3 -m pip install buildozer cython==0.29.33 pillow
        python3 -m pip install python-for-android
    
    - name: Create Icon
      run: |
        if [ ! -f "icon.png" ]; then
          echo "ğŸ“± Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
          wget -O icon.png "https://img.icons8.com/color/512/000000/film-reel.png"
        fi
    
    - name: Pre-install python-for-android
      run: |
        echo "ğŸ“¦ ØªÙ†Ø²ÙŠÙ„ python-for-android Ù…Ø³Ø¨Ù‚Ø§Ù‹..."
        mkdir -p .buildozer/android/platform
        cd .buildozer/android/platform
        git clone --depth=1 https://github.com/kivy/python-for-android.git
        cd python-for-android
        pip3 install -e .
        cd ../../../../  # Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    
    - name: Build APK Step by Step
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ APK Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©..."
        
        # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        echo "1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª..."
        buildozer -v android update
        
        # Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªÙ†Ø¸ÙŠÙ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† python-for-android)
        echo "2. Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ÙŠ..."
        if [ -d ".buildozer/android/platform/python-for-android" ]; then
          buildozer -v android clean
        else
          echo "âš ï¸  ØªØ®Ø·ÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ - python-for-android ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
        fi
        
        # Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        echo "3. ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª..."
        buildozer -v android
        
        # Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„Ø¨Ù†Ø§Ø¡
        echo "4. Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø¨Ù†Ø§Ø¡..."
        buildozer -v android debug 2>&1 | tail -100
        
    - name: Check and Upload APK
      run: |
        echo "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù APK..."
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!"
          ls -la bin/*.apk
        else
          echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ APK"
          echo "=== Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ ==="
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ù†Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±
          cd .buildozer/android/platform/python-for-android
          python3 -m pythonforandroid.toolchain clean_builds
          cd ../../../../  # Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          buildozer android debug
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SpeedFlix-APK
        path: bin/*.apk
        if-no-files-found: error
