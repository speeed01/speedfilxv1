          
name: Build SpeedFlix APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check Files Before Build
      run: |
        echo "ğŸ“ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©..."
        echo "Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: $(pwd)"
        echo "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª:"
        ls -la
        
        echo ""
        echo "=== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† buildozer.spec ==="
        if [ -f "buildozer.spec" ]; then
          echo "âœ… buildozer.spec Ù…ÙˆØ¬ÙˆØ¯"
          echo "Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $(wc -l < buildozer.spec) Ø³Ø·Ø±"
          echo "Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ù„Ø£ÙˆÙ„ 10 Ø£Ø³Ø·Ø±):"
          head -10 buildozer.spec
        else
          echo "âŒ buildozer.spec ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
          exit 1
        fi
        
        echo ""
        echo "=== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† main.py ==="
        if [ -f "main.py" ]; then
          echo "âœ… main.py Ù…ÙˆØ¬ÙˆØ¯"
          echo "Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $(wc -l < main.py) Ø³Ø·Ø±"
        else
          echo "âŒ main.py ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
          exit 1
        fi
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3-pip \
          openjdk-11-jdk \
          zlib1g-dev \
          ccache \
          libncurses5 \
          libncursesw5 \
          unzip \
          zip \
          libssl-dev \
          libffi-dev
    
    - name: Install Python Dependencies
      run: |
        pip3 install --upgrade pip wheel setuptools
        pip3 install buildozer cython==0.29.33
    
    - name: Fix Buildozer Path Issue
      run: |
        echo "ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø³Ø§Ø±..."
        # Ù†Ø³Ø® buildozer.spec Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        if [ -f "buildozer.spec" ]; then
          echo "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­ØªÙˆÙ‰ buildozer.spec:"
          # Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø£Ø³Ø·Ø± Ù…ÙƒØ±Ø±Ø©
          awk '!seen[$0]++' buildozer.spec > temp.spec
          mv temp.spec buildozer.spec
          echo "ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù„Ù"
        fi
    
    - name: Build APK
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ APK..."
        echo "Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: $(pwd)"
        
        # 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† buildozer.spec ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
        if [ ! -f "buildozer.spec" ]; then
          echo "âŒ Ø®Ø·Ø£: buildozer.spec ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ $(pwd)"
          exit 1
        fi
        
        # 2. Ø¨Ù†Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¸ÙŠÙ Ø£ÙˆÙ„ÙŠ
        echo "Ø¨Ù†Ø§Ø¡ APK Ù…Ø¨Ø§Ø´Ø±Ø©..."
        buildozer android debug
        
    - name: Check and Upload APK
      run: |
        echo "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù APK..."
        
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!"
          echo "Ù‚Ø§Ø¦Ù…Ø© Ù…Ù„ÙØ§Øª APK:"
          ls -la bin/*.apk
        else
          echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ APK"
          echo "=== Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø© ==="
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„Ù€ verbose Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø®Ø·Ø£
          echo "Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±..."
          buildozer -v android debug 2>&1 | tail -50
          exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SpeedFlix-APK
        path: bin/*.apk
        retention-days: 7
