
name: Build SpeedFlix APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3-pip \
          openjdk-11-jdk \
          zlib1g-dev \
          ccache \
          libncurses5 \
          libncursesw5 \
          unzip \
          zip \
          libssl-dev \
          libffi-dev \
          autoconf \
          libtool \
          pkg-config \
          wget \
          curl
    
    - name: Install Python Dependencies
      run: |
        python3 -m pip install --upgrade pip wheel setuptools virtualenv
        python3 -m pip install buildozer cython==0.29.33 pillow
    
    - name: Create Icon
      run: |
        if [ ! -f "icon.png" ]; then
          echo "ðŸ“± Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
          wget -q -O icon.png "https://img.icons8.com/color/512/000000/film-reel.png"
        fi
    
    - name: Create Buildozer Spec
      run: |
        echo "ðŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù buildozer.spec..."
        
        # Ù…Ø­ØªÙˆÙ‰ Ù…Ù„Ù buildozer.spec
        cat > buildozer.spec << 'EOF'
[app]

# Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
title = SpeedFlix

# Ø§Ø³Ù… Ø§Ù„Ø­Ø²Ù…Ø© (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹)
package.name = com.speedflix.movies

# Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯
package.domain = org.speedflix

# Ø±Ù‚Ù… Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
version = 1.0

# Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
requirements = python3,kivy==2.2.1,requests,urllib3,certifi,android

# Ø¥ØµØ¯Ø§Ø± Android Ø§Ù„Ø£Ø¯Ù†Ù‰
android.minapi = 21

# Ø¥ØµØ¯Ø§Ø± Android Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
android.api = 33

# Ø¥ØµØ¯Ø§Ø± Android Ù„Ù„Ø¨Ù†Ø§Ø¡
android.ndk = 25b

# Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
android.permissions = INTERNET,ACCESS_NETWORK_STATE,WAKE_LOCK

# Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¥Ù†ØªØ±Ù†Øª
android.allow_backup = True

# Ø§Ù„ØªÙˆØ¬Ù‡
orientation = portrait

# Ø§Ù„Ù†Ø§ÙØ°Ø© ÙƒØ§Ù…Ù„Ø©
fullscreen = 0

# Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
source.dir = .

# Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
source.main = main.py

# Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
source.exclude_exts = spec,pyc,pyo,git,md

# Ø±Ù…Ø² Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
app.orientation = portrait

# Ø§Ø³ØªØ®Ø¯Ø§Ù… AndroidX
android.enable_androidx = True

# Ø¨Ù†Ø§Ø¡ Ù„Ù€ arm64 ÙÙ‚Ø·
android.arch = arm64-v8a

# Ø­Ø¬Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©
android.minsdk = 21
android.maxsdk = 33

# Ø®ÙŠØ§Ø±Ø§Øª Gradle
android.gradle_dependencies = 'com.android.support:support-v4:28.0.0'

# Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
presplash.filename = %(source.dir)s/icon.png

# Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
icon.filename = %(source.dir)s/icon.png

# Ù†ÙˆØ¹ APK
build_type = debug

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°Ø§ÙƒØ±Ø©
android.accept_sdk_license = true
EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ buildozer.spec"
        echo "=== Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù ==="
        cat buildozer.spec
    
    - name: Initialize Buildozer
      run: |
        echo "ðŸ”§ ØªÙ‡ÙŠØ¦Ø© Buildozer..."
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        mkdir -p .buildozer/android/platform
        mkdir -p bin
        
        # Ù†Ø³Ø® python-for-android Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if [ ! -d ".buildozer/android/platform/python-for-android" ]; then
          echo "ðŸ“¦ ØªÙ†Ø²ÙŠÙ„ python-for-android..."
          cd .buildozer/android/platform
          git clone --depth=1 https://github.com/kivy/python-for-android.git
          cd python-for-android
          pip3 install -e .
          cd ../../../../  # Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        fi
    
    - name: Build APK
      run: |
        echo "ðŸš€ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ APK..."
        
        # 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        echo "Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª..."
        buildozer -v android update
        
        # 2. Ø§Ù„ØªÙ†Ø¸ÙŠÙ
        echo "Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„ØªÙ†Ø¸ÙŠÙ..."
        buildozer -v android clean || true
        
        # 3. Ø§Ù„Ø¨Ù†Ø§Ø¡
        echo "Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ø¨Ù†Ø§Ø¡..."
        timeout 1800 buildozer -v android debug  # 30 Ø¯Ù‚ÙŠÙ‚Ø©
        
    - name: Check APK File
      run: |
        echo "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù APK..."
        sleep 5
        
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!"
          ls -la bin/*.apk
          
          # Ø¹Ø±Ø¶ Ø­Ø¬Ù… APK
          for apk in bin/*.apk; do
            echo "ðŸ“¦ $apk - $(du -h "$apk" | cut -f1)"
          done
        else
          echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ APK"
          echo "=== Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø© ==="
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ù†Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±
          if [ -d ".buildozer/android/platform/python-for-android" ]; then
            cd .buildozer/android/platform/python-for-android
            python3 -m pythonforandroid.toolchain apk \
              --private ../app \
              --package com.speedflix.movies \
              --name SpeedFlix \
              --version 1.0 \
              --bootstrap sdl2 \
              --requirements python3,kivy,requests \
              --arch arm64-v8a
            mv *.apk ../../../../bin/ 2>/dev/null || true
          fi
        fi
        
    - name: Upload APK
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: SpeedFlix-APK
        path: bin/
        retention-days: 7
